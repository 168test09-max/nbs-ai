import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signOut,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  onSnapshot, 
  serverTimestamp, 
  deleteDoc, 
  doc,
  updateDoc
} from 'firebase/firestore';
import { 
  Bot, 
  BookOpen, 
  Link as LinkIcon, 
  Plus, 
  LogOut, 
  ExternalLink, 
  Trash2, 
  Share2,
  Lock,
  Briefcase,
  Megaphone,
  Users,
  Package,
  MoreHorizontal,
  MessageCircle,
  ClipboardCheck,
  Sparkles,
  Search,
  Settings,
  Edit,
  X,
  Image as ImageIcon,
  ShieldCheck
} from 'lucide-react';

// --- è¨­å®šå€ ---

// 1. Firebase è¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyB7RDcx7irw6JyRUx-qhBEMUunH__c0I04",
  authDomain: "nbs168-ai01.firebaseapp.com",
  projectId: "nbs168-ai01",
  storageBucket: "nbs168-ai01.firebasestorage.app",
  messagingSenderId: "911620241362",
  appId: "1:911620241362:web:8b49b515749b51c0e37a0b",
  measurementId: "G-NZTWEVM6H4"
};

// 2. LOGO è¨­å®š
// ğŸ”´ è«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›æˆæ‚¨ LOGO çš„çœŸå¯¦ç¶²å€
// ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆï¼šç”±æ–¼ Imgur é™åˆ¶ï¼Œå»ºè­°ä½¿ç”¨ https://zh-tw.imgbb.com/ æˆ– https://postimages.org/
// ä¸Šå‚³å¾Œè«‹è¤‡è£½ã€Œç›´æ¥é€£çµ (Direct Link)ã€ï¼Œçµå°¾é€šå¸¸æ˜¯ .jpg æˆ– .png
const LOGO_URL = "https://meee.com.tw/cBmkwvn"; 

// 3. ç®¡ç†å“¡å¯†ç¢¼
const ADMIN_PASSWORD = "888888"; 

// è³‡æ–™åº«å‘½åç©ºé–“
const DB_SCOPE = 'nbs-ai-share';

// åˆå§‹åŒ– Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Categories Config ---
type CategoryType = 'admin' | 'marketing' | 'recruiting' | 'product' | 'community' | 'claims' | 'fun' | 'other';

const CATEGORY_CONFIG: Record<CategoryType, { label: string; icon: any; color: string }> = {
  admin:      { label: 'è¡Œæ”¿', icon: Briefcase,      color: 'bg-blue-100 text-blue-700' },
  marketing:  { label: 'è¡ŒéŠ·', icon: Megaphone,      color: 'bg-pink-100 text-pink-700' },
  recruiting: { label: 'å¢å“¡', icon: Users,          color: 'bg-purple-100 text-purple-700' },
  product:    { label: 'å•†å“', icon: Package,        color: 'bg-orange-100 text-orange-700' },
  community:  { label: 'ç¤¾ç¾¤', icon: MessageCircle,  color: 'bg-indigo-100 text-indigo-700' },
  claims:     { label: 'ç†è³ ', icon: ClipboardCheck, color: 'bg-red-100 text-red-700' },
  fun:        { label: 'å¥½ç©', icon: Sparkles,       color: 'bg-yellow-100 text-yellow-700' },
  other:      { label: 'å…¶å®ƒ', icon: MoreHorizontal, color: 'bg-gray-100 text-gray-700' },
};

// ============================================================================
// ğŸš€ è³‡æ–™åº«åŒ¯å…¥å€ (å›ºå®šé€£çµ)
// ============================================================================

const IMPORTED_DATA = [
  "NBS-åˆ†æYTå½±ç‰‡ | https://gemini.google.com/gem/a721cbc618f9 | å…¶å®ƒ",
  "NBS-FAB è¡ŒéŠ· LINE é‚€ç´„è©±ç¨¿ç”Ÿæˆå™¨ | https://gemini.google.com/gem/97b7f3ac234f | è¡ŒéŠ·",
  "NBSè¨­è¨ˆ_å››æ ¼æ¼«ç•«è…³æœ¬ç”Ÿæˆå™¨ï¼ˆé‡‘èä¿éšªè·å ´ç‰ˆï½œåˆè¦ï¼‰ | https://gemini.google.com/gem/da1761f3de1a | ç¤¾ç¾¤",
  "NBSæ•´ç†_äººå£½å¥å‘Šå¡«å¯«ã€ç–¾ç—…å•å·èˆ‡æ ¸ä¿åƒè€ƒæŒ‡å— | https://notebooklm.google.com/notebook/7824725f-c976-400f-943c-b5097f35766c | è¡Œæ”¿",
  "NBSæ•´ç†_ä¿æˆ¶æœå‹™èˆ‡å¥‘ç´„è®Šæ›´äº‹é … | https://notebooklm.google.com/notebook/d69dff67-4ecf-43d1-b71e-06d226f032bd | è¡Œæ”¿",
  "NBSæ•´ç†_äººå£½é¦–æœŸä¿è²»æ‰£æ¬¾æ ¸å°å¤©æ•¸æŒ‡å— | https://notebooklm.google.com/notebook/c9e90e05-b833-44f7-b8a4-9e4ebfca95bf | è¡Œæ”¿",
  "å•†å“_å¯¦æ”¯å¯¦ä»˜é†«ç™‚éšªä¿è²»èª¿æ¼²è¦å®š | https://notebooklm.google.com/notebook/7cc5e453-e49c-448f-b582-ce9e2f20e583 | å•†å“",
  "NBSæ•´ç†_ä¿éšªè·æ¥­åˆ†é¡(ç”¢å£½éšª) | https://notebooklm.google.com/notebook/5f3e21d1-25b0-4ea2-84fd-e39051513076 | è¡Œæ”¿",
  "NBSæ•´ç†_äººå£½é«”æª¢é†«ç™‚é™¢æ‰€è³‡æ–™èˆ‡æ³¨æ„äº‹é … | https://notebooklm.google.com/notebook/7c934959-3f82-4b3d-b670-dd1559e8141f | è¡Œæ”¿",
  "NBSæ•´ç†_ç†è³ å ±å ±ï¼šç–¾ç—…ã€ä¿éšªèˆ‡å¯¦å‹™æ¡ˆä¾‹ | https://notebooklm.google.com/notebook/e53fb580-1a4f-4cf6-955a-f23019fcfb7a | ç†è³ ",
  "NBS-å†¬å­£æˆ€æ­Œä¸‰æ ¼åœ– â€“ GEMç‰ˆ | https://gemini.google.com/gem/79e533008773 | å¥½ç©"
];

// ============================================================================
// Helper Functions
// ============================================================================

const parseCategory = (input: string): CategoryType => {
  const map: Record<string, CategoryType> = {
    'è¡Œæ”¿': 'admin',
    'è¡ŒéŠ·': 'marketing',
    'å¢å“¡': 'recruiting',
    'å•†å“': 'product',
    'ç¤¾ç¾¤': 'community',
    'ç†è³ ': 'claims',
    'å¥½ç©': 'fun',
    'å…¶å®ƒ': 'other'
  };
  return map[input?.trim()] || 'other';
};

const determineType = (url: string): 'gem' | 'notebook' | 'other' => {
  if (url.includes('gemini.google.com') || url.includes('gem.google.com')) return 'gem';
  if (url.includes('notebooklm.google.com')) return 'notebook';
  return 'other';
};

// --- Types ---
interface LinkItem {
  id: string;
  title: string;
  url: string;
  type: 'gem' | 'notebook' | 'other';
  category: CategoryType;
  description?: string;
  createdAt: any;
  addedBy: string;
  isFixed?: boolean;
}

const generateFixedLinks = (): LinkItem[] => {
  const links: LinkItem[] = [];
  
  IMPORTED_DATA.forEach((item, index) => {
    const parts = item.split('|').map(s => s.trim());
    if (parts.length >= 2 && parts[0] && parts[1]) {
      const title = parts[0];
      const url = parts[1];
      const categoryStr = parts[2] || 'å…¶å®ƒ';
      
      links.push({
        id: `auto-${index}`,
        title: title,
        url: url,
        type: determineType(url),
        category: parseCategory(categoryStr),
        description: '',
        createdAt: Date.now(), // Use current time for static links
        addedBy: 'system',
        isFixed: true
      });
    }
  });

  return links;
};

const FIXED_LINKS = generateFixedLinks();

// --- Components ---

// 1. Logo Component (With Error Handling)
const LogoDisplay = ({ className = "" }: { className?: string }) => {
  const [error, setError] = useState(false);

  if (error || !LOGO_URL) {
    return (
      <div className={`bg-indigo-50 flex items-center justify-center ${className}`}>
        <ImageIcon className="text-indigo-300 w-1/2 h-1/2" />
      </div>
    );
  }

  return (
    <div className={`bg-white flex items-center justify-center overflow-hidden ${className}`}>
      <img 
        src={LOGO_URL} 
        alt="NBS AI LOGO" 
        className="w-full h-full object-contain p-1" // object-contain ç¢ºä¿ LOGO å®Œæ•´é¡¯ç¤ºä¸è¢«åˆ‡è£
        onError={() => setError(true)}
      />
    </div>
  );
};

// 2. Login Screen
const LoginScreen = ({ onLogin }: { onLogin: () => void }) => {
  const [isLoading, setIsLoading] = useState(false);

  const handleLogin = async () => {
    setIsLoading(true);
    try {
      await onLogin();
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 flex items-center justify-center p-4">
      <div className="bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden group">
        
        {/* èƒŒæ™¯è£é£¾ */}
        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

        <div className="w-28 h-28 mx-auto mb-8 rounded-2xl overflow-hidden shadow-2xl shadow-indigo-500/20 bg-white ring-4 ring-white/10">
          <LogoDisplay className="w-full h-full" />
        </div>
        
        <h1 className="text-2xl font-bold text-white mb-2 tracking-wide">NBS_AIæ‡‰ç”¨åˆ†äº«</h1>
        <p className="text-indigo-200 mb-8 text-sm font-light">
          æ•´åˆ â€¢ æ•ˆç‡ â€¢ è³‡æº<br/>æ‚¨çš„å°ˆå±¬ AI çŸ¥è­˜åº«
        </p>
        
        <button
          onClick={handleLogin}
          disabled={isLoading}
          className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-indigo-900/50"
        >
          {isLoading ? (
            <span className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
          ) : (
            <>
              <Lock className="w-4 h-4" />
              <span>é€²å…¥ç³»çµ±</span>
            </>
          )}
        </button>
      </div>
    </div>
  );
};

// 3. Add/Edit Modal
const AddLinkModal = ({ 
  isOpen, 
  onClose, 
  onAdd,
  initialData
}: { 
  isOpen: boolean; 
  onClose: () => void; 
  onAdd: (data: Omit<LinkItem, 'id' | 'createdAt' | 'addedBy'>) => void;
  initialData?: LinkItem | null;
}) => {
  const [title, setTitle] = useState('');
  const [url, setUrl] = useState('');
  const [type, setType] = useState<'gem' | 'notebook' | 'other'>('gem');
  const [category, setCategory] = useState<CategoryType>('other');
  const [description, setDescription] = useState('');

  useEffect(() => {
    if (initialData) {
      setTitle(initialData.title);
      setUrl(initialData.url);
      setType(initialData.type);
      setCategory(initialData.category);
      setDescription(initialData.description || '');
    } else {
      resetForm();
    }
  }, [initialData, isOpen]);

  const resetForm = () => {
    setTitle('');
    setUrl('');
    setType('gem');
    setCategory('other');
    setDescription('');
  }

  const handleUrlChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newUrl = e.target.value;
    setUrl(newUrl);
    setType(determineType(newUrl));
  };

  if (!isOpen) return null;

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onAdd({ title, url, type, category, description });
    resetForm();
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden animate-in slide-in-from-bottom-10 duration-300">
        <div className="p-6 max-h-[85vh] overflow-y-auto">
          <div className="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden"></div>
          <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            {initialData ? <Edit className="w-5 h-5 text-indigo-600" /> : <Plus className="w-5 h-5 text-indigo-600" />}
            {initialData ? 'ç·¨è¼¯è³‡æº' : 'æ–°å¢è³‡æº'}
          </h2>
          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="space-y-1.5">
              <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">é€£çµç¶²å€ (URL)</label>
              <input
                required
                type="url"
                value={url}
                onChange={handleUrlChange}
                placeholder="https://..."
                className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent outline-none transition-all"
              />
            </div>

            <div className="space-y-1.5">
              <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">æ¨™é¡Œåç¨±</label>
              <input
                required
                type="text"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="ä¾‹å¦‚ï¼šè¡ŒéŠ·æ–‡æ¡ˆå°å¹«æ‰‹"
                className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent outline-none transition-all"
              />
            </div>

            <div className="space-y-1.5">
              <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">æ¥­å‹™åˆ†é¡</label>
              <div className="relative">
                <select 
                  value={category}
                  onChange={(e) => setCategory(e.target.value as CategoryType)}
                  className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent outline-none appearance-none transition-all"
                >
                  {Object.entries(CATEGORY_CONFIG).map(([key, config]) => (
                    <option key={key} value={key}>
                      {config.label}
                    </option>
                  ))}
                </select>
                <div className="absolute right-4 top-3.5 pointer-events-none text-gray-400">
                  <ExternalLink className="w-4 h-4 rotate-90" /> 
                </div>
              </div>
            </div>

            <div className="flex gap-3 pt-2">
              <button
                type="button"
                onClick={onClose}
                className="flex-1 px-4 py-3.5 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button
                type="submit"
                className="flex-1 px-4 py-3.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95"
              >
                {initialData ? 'å„²å­˜è®Šæ›´' : 'ç¢ºèªæ–°å¢'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

// 4. Admin Panel Component (ç®¡ç†å“¡å¾Œå°)
const AdminPanel = ({ 
  links, 
  onDelete, 
  onEdit, 
  onClose,
  onAdd
}: { 
  links: LinkItem[], 
  onDelete: (id: string) => void, 
  onEdit: (link: LinkItem) => void, 
  onClose: () => void,
  onAdd: () => void
}) => {
  const [adminSearch, setAdminSearch] = useState('');

  const filteredAdminLinks = links.filter(link => 
    link.title.toLowerCase().includes(adminSearch.toLowerCase()) ||
    link.category.includes(adminSearch)
  );

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden animate-in zoom-in-95">
        
        {/* Header */}
        <div className="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-100 p-2 rounded-lg">
              <Settings className="w-6 h-6 text-indigo-600" />
            </div>
            <div>
              <h2 className="text-xl font-bold text-gray-800">ç®¡ç†å¾Œå°</h2>
              <p className="text-xs text-gray-500">å…± {links.length} ç­†è³‡æ–™</p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full transition-colors">
            <X className="w-6 h-6 text-gray-500" />
          </button>
        </div>

        {/* Toolbar */}
        <div className="p-4 border-b border-gray-100 flex gap-3 bg-white">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-2.5 w-5 h-5 text-gray-400" />
            <input 
              type="text" 
              placeholder="æœå°‹é€£çµ..." 
              value={adminSearch}
              onChange={(e) => setAdminSearch(e.target.value)}
              className="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
            />
          </div>
          <button 
            onClick={onAdd}
            className="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 flex items-center gap-2"
          >
            <Plus className="w-4 h-4" />
            æ–°å¢
          </button>
        </div>

        {/* List */}
        <div className="flex-1 overflow-y-auto bg-gray-50 p-4">
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <table className="w-full text-left">
              <thead className="bg-gray-50 border-b border-gray-100">
                <tr>
                  <th className="py-3 px-4 font-semibold text-xs text-gray-500 uppercase">æ¨™é¡Œ / ç¶²å€</th>
                  <th className="py-3 px-4 font-semibold text-xs text-gray-500 uppercase w-24">åˆ†é¡</th>
                  <th className="py-3 px-4 font-semibold text-xs text-gray-500 uppercase w-20 text-right">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {filteredAdminLinks.map(link => (
                  <tr key={link.id} className="hover:bg-gray-50 transition-colors group">
                    <td className="py-3 px-4">
                      <div className="font-medium text-gray-800 line-clamp-1">{link.title}</div>
                      <div className="text-xs text-gray-400 line-clamp-1 font-mono">{link.url}</div>
                    </td>
                    <td className="py-3 px-4">
                      <span className={`inline-flex px-2 py-1 rounded text-xs font-bold ${CATEGORY_CONFIG[link.category]?.color.replace('text-', 'bg-').replace('700', '100')} ${CATEGORY_CONFIG[link.category]?.color}`}>
                        {CATEGORY_CONFIG[link.category]?.label}
                      </span>
                    </td>
                    <td className="py-3 px-4 text-right">
                      <div className="flex items-center justify-end gap-1">
                        <button onClick={() => onEdit(link)} className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-md">
                          <Edit className="w-4 h-4" />
                        </button>
                        <button onClick={() => onDelete(link.id)} className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {filteredAdminLinks.length === 0 && (
              <div className="p-8 text-center text-gray-400">
                ç„¡ç›¸é—œè³‡æ–™
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// 5. Main App Component
export default function App() {
  const [user, setUser] = useState<any>(null);
  const [links, setLinks] = useState<LinkItem[]>(FIXED_LINKS);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [filter, setFilter] = useState<'all' | CategoryType>('all');
  const [searchTerm, setSearchTerm] = useState('');
  
  // Admin States
  const [isAdmin, setIsAdmin] = useState(false);
  const [showAdminPanel, setShowAdminPanel] = useState(false);
  const [editingLink, setEditingLink] = useState<LinkItem | null>(null);

  // --- Auth & Data Effects ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
         try {
           await signInWithCustomToken(auth, __initial_auth_token);
         } catch(e) {}
      }
    };
    initAuth();

    const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (!currentUser) setLoading(false);
    });
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', DB_SCOPE, 'public', 'data', 'sharedLinks'));

    const unsubscribeData = onSnapshot(q, 
      (snapshot) => {
        const dbItems = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            category: data.category || 'other'
          };
        }) as LinkItem[];
        
        dbItems.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
        setLinks([...FIXED_LINKS, ...dbItems]);
        setLoading(false);
      },
      (error) => {
        console.error("Error:", error);
        setLinks([...FIXED_LINKS]);
        setLoading(false);
      }
    );
    return () => unsubscribeData();
  }, [user]);

  // --- Handlers ---
  const handleLogin = async () => await signInAnonymously(auth);
  const handleLogout = async () => {
    setIsAdmin(false);
    setShowAdminPanel(false);
    await signOut(auth);
  };

  const handleAdminLogin = () => {
    const input = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
    if (input === ADMIN_PASSWORD) {
      setIsAdmin(true);
      setShowAdminPanel(true);
    } else if (input !== null) {
      alert("å¯†ç¢¼éŒ¯èª¤");
    }
  };

  const handleAddOrEditLink = async (data: Omit<LinkItem, 'id' | 'createdAt' | 'addedBy'>) => {
    if (!user) return;

    try {
      if (editingLink) {
        // Edit Mode
        if (editingLink.id.startsWith('auto-')) {
          alert('ç³»çµ±å›ºå®šé€£çµç„¡æ³•ç·¨è¼¯');
          return;
        }
        await updateDoc(doc(db, 'artifacts', DB_SCOPE, 'public', 'data', 'sharedLinks', editingLink.id), {
          ...data
        });
      } else {
        // Add Mode
        await addDoc(collection(db, 'artifacts', DB_SCOPE, 'public', 'data', 'sharedLinks'), {
          ...data,
          createdAt: serverTimestamp(),
          addedBy: user.uid
        });
      }
      setIsModalOpen(false);
      setEditingLink(null);
    } catch (e) {
      console.error(e);
      alert('æ“ä½œå¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æ¬Šé™');
    }
  };

  const handleDeleteLink = async (id: string) => {
    if (id.startsWith('auto-')) {
      alert('ç³»çµ±å›ºå®šé€£çµç„¡æ³•åˆªé™¤ï¼Œè«‹ç”±ç¨‹å¼ç¢¼ä¿®æ”¹');
      return;
    }
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é€£çµå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
    
    try {
      await deleteDoc(doc(db, 'artifacts', DB_SCOPE, 'public', 'data', 'sharedLinks', id));
    } catch (e) {
      console.error(e);
      alert('åˆªé™¤å¤±æ•—');
    }
  };

  const openEditModal = (link: LinkItem) => {
    setEditingLink(link);
    setIsModalOpen(true);
  };

  const openAddModal = () => {
    setEditingLink(null);
    setIsModalOpen(true);
  };

  // --- Filtering ---
  const filteredLinks = useMemo(() => {
    return links.filter(link => {
      const matchCategory = filter === 'all' || link.category === filter;
      const matchSearch = searchTerm === '' || 
        link.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
        link.url.toLowerCase().includes(searchTerm.toLowerCase());
      return matchCategory && matchSearch;
    });
  }, [links, filter, searchTerm]);

  // --- Render ---
  if (!user) return <LoginScreen onLogin={handleLogin} />;

  return (
    <div className="min-h-screen bg-slate-50 pb-20">
      {/* Header */}
      <header className="bg-white sticky top-0 z-30 border-b border-gray-200 safe-top">
        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-lg overflow-hidden shadow-sm border border-gray-100 bg-white p-0.5">
              <LogoDisplay className="w-full h-full rounded-md" />
            </div>
            <div>
              <h1 className="font-bold text-gray-800 text-lg leading-tight">NBS_AIæ‡‰ç”¨åˆ†äº«</h1>
              <p className="text-[10px] text-gray-400 font-medium tracking-wider">RESOURCE HUB</p>
            </div>
          </div>
          <div className="flex items-center gap-1">
            {isAdmin ? (
              <button 
                onClick={() => setShowAdminPanel(true)}
                className="p-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full transition-colors"
                title="é–‹å•Ÿç®¡ç†å¾Œå°"
              >
                <ShieldCheck className="w-5 h-5" />
              </button>
            ) : (
              <button 
                onClick={handleAdminLogin}
                className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors"
                title="ç®¡ç†å“¡ç™»å…¥"
              >
                <Settings className="w-5 h-5" />
              </button>
            )}
            <button 
              onClick={handleLogout}
              className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors"
            >
              <LogOut className="w-5 h-5" />
            </button>
          </div>
        </div>

        {/* Search Bar */}
        <div className="max-w-3xl mx-auto px-4 pb-2">
          <div className="relative group">
            <input
              type="text"
              placeholder="æœå°‹é€£çµ..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-8 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent outline-none transition-all text-sm"
            />
            <Search className="absolute left-3 top-2.5 w-5 h-5 text-gray-400 group-focus-within:text-indigo-500 transition-colors" />
            {searchTerm && (
              <button 
                onClick={() => setSearchTerm('')}
                className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600"
              >
                <X className="w-4 h-4" />
              </button>
            )}
          </div>
        </div>

        {/* Categories Filter */}
        <div className="px-4 pb-3 max-w-3xl mx-auto flex gap-2 overflow-x-auto no-scrollbar items-center">
          <button
            onClick={() => setFilter('all')}
            className={`px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-colors border ${
              filter === 'all' 
                ? 'bg-gray-800 text-white border-gray-800' 
                : 'bg-white text-gray-600 border-gray-200'
            }`}
          >
            å…¨éƒ¨
          </button>
          {Object.entries(CATEGORY_CONFIG).map(([key, config]) => (
            <button
              key={key}
              onClick={() => setFilter(key as CategoryType)}
              className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors flex items-center gap-1.5 border ${
                filter === key 
                  ? `${config.color.replace('bg-', 'bg-opacity-100 ').replace('text-', 'text-white bg-')}`
                  : 'bg-white text-gray-600 border-gray-200'
              } ${filter === key ? 'border-transparent shadow-sm' : ''}`}
              style={filter === key ? { backgroundColor: 'var(--tw-bg-opacity)' } : {}}
            >
              {filter === key ? (
                <span className={`flex items-center gap-1.5 ${config.color} px-2 -ml-2 py-0.5 rounded-full bg-opacity-20`}>
                   <config.icon className="w-3.5 h-3.5" />
                   {config.label}
                </span>
              ) : (
                <>
                  <config.icon className="w-3.5 h-3.5 opacity-50" />
                  {config.label}
                </>
              )}
            </button>
          ))}
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-3xl mx-auto p-4 space-y-4">
        {loading ? (
          <div className="flex justify-center py-10">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          </div>
        ) : filteredLinks.length === 0 ? (
          <div className="text-center py-20 text-gray-400">
            <div className="bg-gray-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-gray-200">
              <Search className="w-8 h-8 opacity-20" />
            </div>
            <p className="font-medium text-gray-500">æ‰¾ä¸åˆ°ç›¸é—œè³‡æº</p>
            <p className="text-xs mt-1">è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–åˆ†é¡</p>
          </div>
        ) : (
          filteredLinks.map((link, idx) => {
            const catConfig = CATEGORY_CONFIG[link.category] || CATEGORY_CONFIG.other;
            return (
              <div 
                key={link.id}
                className="group bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all active:scale-[0.99] relative overflow-hidden"
                style={{ animationDelay: `${idx * 50}ms` }}
              >
                {/* Category Badge */}
                <div className={`absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-[10px] font-bold tracking-wider uppercase ${catConfig.color} bg-opacity-10`}>
                  {catConfig.label}
                </div>

                <div className="flex items-start gap-4">
                  {/* Icon Box */}
                  <div className={`shrink-0 w-12 h-12 rounded-xl flex items-center justify-center mt-1 shadow-sm ${
                    link.type === 'gem' ? 'bg-indigo-50 text-indigo-600' : 
                    link.type === 'notebook' ? 'bg-amber-50 text-amber-600' : 
                    'bg-emerald-50 text-emerald-600'
                  }`}>
                    {link.type === 'gem' && <Bot className="w-6 h-6" />}
                    {link.type === 'notebook' && <BookOpen className="w-6 h-6" />}
                    {link.type === 'other' && <LinkIcon className="w-6 h-6" />}
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0 pr-8">
                    <h3 className="font-bold text-gray-800 text-[17px] leading-snug mb-1 line-clamp-2">{link.title}</h3>
                    
                    {link.description && (
                      <p className="text-xs text-gray-500 line-clamp-1 mb-2">{link.description}</p>
                    )}
                    
                    <div className="flex items-center mt-3 pt-3 border-t border-gray-50">
                      <a 
                        href={link.url}
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="flex-1 flex items-center gap-1.5 text-xs font-bold text-indigo-600 hover:text-indigo-800 transition-colors"
                      >
                        ç«‹å³é–‹å•Ÿ <ExternalLink className="w-3 h-3" />
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        )}
      </main>

      {/* FAB - åƒ…ç®¡ç†å“¡å¯è¦‹ï¼Œæˆ–è¦–ç‚ºå¤§å®¶éƒ½èƒ½æ–°å¢ */}
      <button
        onClick={openAddModal}
        className="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-600/40 flex items-center justify-center hover:bg-indigo-700 active:scale-90 transition-all z-40"
      >
        <Plus className="w-7 h-7" />
      </button>

      {/* Modals */}
      <AddLinkModal 
        isOpen={isModalOpen} 
        onClose={() => { setIsModalOpen(false); setEditingLink(null); }} 
        onAdd={handleAddOrEditLink}
        initialData={editingLink}
      />

      {showAdminPanel && (
        <AdminPanel 
          links={links} 
          onDelete={handleDeleteLink} 
          onEdit={openEditModal}
          onAdd={openAddModal}
          onClose={() => setShowAdminPanel(false)}
        />
      )}
    </div>
  );
}
